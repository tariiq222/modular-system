# اختبار نظام الصلاحيات في التطبيق

تم إنشاء مجموعة من الاختبارات للتحقق من صحة وظائف نظام الصلاحيات (Permissions System) في التطبيق. يتكون نظام الصلاحيات من المكونات التالية:

## 1. المكونات الرئيسية للنظام

### 1.1. الكيانات (Entities)

- **Permission**: يمثل صلاحية محددة (مثل قراءة المستخدمين، تعديل الملفات الشخصية، إلخ)
- **Role**: يمثل دور المستخدم (مثل مدير، مشرف، مستخدم عادي) ويحتوي على مجموعة من الصلاحيات
- **ResourcePolicy**: يمثل سياسات الوصول إلى موارد محددة (الصلاحيات الأفقية)

### 1.2. الخدمات (Services)

- **PermissionService**: لإدارة الصلاحيات (إنشاء، قراءة، تعديل، حذف)
- **RoleService**: لإدارة الأدوار وتعيين الصلاحيات لها
- **PolicyService**: لإدارة سياسات الوصول إلى الموارد المحددة

### 1.3. آليات الحماية (Guards)

- **PermissionsGuard**: للتحقق من صلاحيات المستخدم عند الوصول إلى نقاط النهاية (Endpoints)
- **RolesGuard**: للتحقق من أدوار المستخدم

### 1.4. الزخارف (Decorators)

- **RequirePermissions**: لتحديد الصلاحيات المطلوبة للوصول إلى مسار معين
- **RequireAction**: لتحديد عملية ومورد محددين للوصول
- **RequireActions**: لتحديد عدة عمليات لنفس المورد
- **RequireManage**: اختصار لتحديد صلاحية الإدارة الكاملة لمورد

## 2. الاختبارات المنفذة

### 2.1. اختبارات الوحدة (Unit Tests)

#### اختبارات خدمة الصلاحيات (PermissionService)

- إنشاء صلاحية جديدة
- إرجاع صلاحية موجودة مسبقًا إذا تم محاولة إنشائها مرة أخرى

#### اختبارات خدمة الأدوار (RoleService)

- إنشاء دور جديد مع صلاحيات
- التحقق من امتلاك الدور لصلاحية محددة
- التحقق من عدم امتلاك الدور لصلاحية غير موجودة

#### اختبارات خدمة السياسات (PolicyService)

- التحقق من السماح بالوصول بناءً على سياسة المورد
- رفض الوصول بناءً على سياسة المورد

#### اختبارات حارس الصلاحيات (PermissionsGuard)

- السماح بالوصول للمسارات العامة
- السماح بالوصول إذا لم تكن هناك صلاحيات مطلوبة محددة
- التحقق من صلاحيات دور المستخدم

### 2.2. اختبارات التكامل (Integration Tests)

#### اختبارات الوصول إلى نقاط نهاية الصلاحيات

- يجب أن يتمكن المدير (ADMIN) من الوصول إلى قائمة الصلاحيات
- يجب ألا يتمكن المشرف (MODERATOR) من الوصول إلى قائمة الصلاحيات
- يجب ألا يتمكن المستخدم العادي (USER) من الوصول إلى قائمة الصلاحيات
- يجب رفض الطلبات غير المصادق عليها

#### اختبارات الوصول إلى نقاط نهاية الأدوار

- يجب أن يتمكن المدير من الوصول إلى قائمة الأدوار
- يجب أن يتمكن المشرف من قراءة الأدوار
- يجب ألا يتمكن المشرف من إنشاء دور
- يجب أن يتمكن المدير من إنشاء دور

#### اختبارات الوصول إلى الملف الشخصي

- يجب أن يتمكن المستخدم العادي من الوصول إلى ملفه الشخصي
- يجب أن يتمكن المستخدم العادي من تحديث ملفه الشخصي

#### اختبارات الوصول المتقاطع بين الأدوار

- يجب أن يتمكن المدير من الوصول إلى نقاط نهاية الملف الشخصي
- يجب أن يتمكن المشرف من الوصول إلى نقاط نهاية الملف الشخصي

## 3. كيفية تشغيل الاختبارات

```bash
# تشغيل اختبارات الوحدة
npm test -- src/modules/permissions/test/permissions-fixed.spec.ts

# تشغيل اختبارات التكامل
npm test -- src/modules/permissions/test/permissions.integration.spec.ts
```

## 4. ملاحظات هامة

- قد تحتاج إلى تعديل اختبارات التكامل إذا كانت قاعدة البيانات غير متوفرة أو غير مهيأة بشكل صحيح
- قبل تشغيل اختبارات التكامل، تأكد من تهيئة البيانات الأساسية مثل الأدوار والصلاحيات الافتراضية
- يمكن تعديل آلية توليد رموز JWT في اختبارات التكامل حسب طريقة التنفيذ في التطبيق
- إذا واجهت مشاكل في اختبارات TypeScript، يمكن إضافة الخيار `--no-strict` إلى أمر تشغيل الاختبارات

## 5. المزيد من الاختبارات المقترحة

- اختبار تحديث الصلاحيات وإزالتها من الأدوار
- اختبار إنشاء وتحديث سياسات الموارد
- اختبار التفاعل بين سياسات الموارد المختلفة (عامة ومحددة)
- اختبار الأداء مع عدد كبير من الصلاحيات والأدوار
- اختبار التزامن في طلبات التحقق من الصلاحيات المتعددة